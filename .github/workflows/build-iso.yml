name: Build NixOS ISO

on:
  # Trigger on push to main/master
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'

  # Manual workflow dispatch
  workflow_dispatch:

  # Daily scheduled build at 00:00 UTC
  schedule:
    - cron: '0 0 * * *'

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        arch: [x86_64-linux, aarch64-linux]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            experimental-features = nix-command flakes

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build ISO for ${{ matrix.arch }}
        run: |
          nix build .#packages.${{ matrix.arch }}.iso --print-build-logs

      - name: Get ISO filename
        id: iso-info
        run: |
          ARCH=$(echo "${{ matrix.arch }}" | cut -d'-' -f1)
          ISO_PATH=$(readlink -f result/iso/*.iso)
          ISO_NAME="nixos-minimal-${ARCH}-custom.iso"
          echo "iso_path=${ISO_PATH}" >> $GITHUB_OUTPUT
          echo "iso_name=${ISO_NAME}" >> $GITHUB_OUTPUT
          echo "arch=${ARCH}" >> $GITHUB_OUTPUT

      - name: Validate ISO
        run: |
          ISO_PATH="${{ steps.iso-info.outputs.iso_path }}"

          # Check if ISO exists
          if [ ! -f "$ISO_PATH" ]; then
            echo "Error: ISO file not found at $ISO_PATH"
            exit 1
          fi

          # Check ISO size (should be > 100MB)
          ISO_SIZE=$(stat -c%s "$ISO_PATH")
          MIN_SIZE=$((100 * 1024 * 1024))
          if [ $ISO_SIZE -lt $MIN_SIZE ]; then
            echo "Error: ISO size ($ISO_SIZE bytes) is too small"
            exit 1
          fi

          echo "âœ… ISO validation passed"
          echo "   File: $ISO_PATH"
          echo "   Size: $(numfmt --to=iec-i --suffix=B $ISO_SIZE)"

      - name: Rename ISO
        run: |
          cp "${{ steps.iso-info.outputs.iso_path }}" "${{ steps.iso-info.outputs.iso_name }}"

      - name: Upload to GitHub Actions Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.iso-info.outputs.iso_name }}
          path: ${{ steps.iso-info.outputs.iso_name }}
          retention-days: 90

      - name: Upload to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.iso-info.outputs.iso_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
