name: Build NixOS ISO

on:
  # Trigger on push to main/master
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.serena/memories/**'

  # Manual workflow dispatch
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        target: [x86_64-generic, aarch64-generic, x86_64-t2]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up QEMU for multi-architecture builds
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            experimental-features = nix-command flakes
            extra-platforms = aarch64-linux

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build ISO for ${{ matrix.target }}
        run: |
          case "${{ matrix.target }}" in
            x86_64-generic)
              nix build .#packages.x86_64-linux.iso --print-build-logs
              ;;
            aarch64-generic)
              nix build .#packages.aarch64-linux.iso --print-build-logs
              ;;
            x86_64-t2)
              nix build .#packages.x86_64-linux.iso-t2 --print-build-logs
              ;;
            *)
              echo "Unknown target: ${{ matrix.target }}"
              exit 1
              ;;
          esac

      - name: Get ISO filename
        id: iso-info
        run: |
          case "${{ matrix.target }}" in
            x86_64-generic)
              ISO_NAME="nixos-minimal-x86_64-custom.iso"
              ;;
            aarch64-generic)
              ISO_NAME="nixos-minimal-aarch64-custom.iso"
              ;;
            x86_64-t2)
              ISO_NAME="nixos-minimal-x86_64-t2-custom.iso"
              ;;
            *)
              echo "Unknown target: ${{ matrix.target }}"
              exit 1
              ;;
          esac

          ISO_PATH=$(readlink -f result/iso/*.iso)
          echo "iso_path=${ISO_PATH}" >> $GITHUB_OUTPUT
          echo "iso_name=${ISO_NAME}" >> $GITHUB_OUTPUT

      - name: Validate ISO
        run: |
          ISO_PATH="${{ steps.iso-info.outputs.iso_path }}"

          # Check if ISO exists
          if [ ! -f "$ISO_PATH" ]; then
            echo "Error: ISO file not found at $ISO_PATH"
            exit 1
          fi

          # Check ISO size (should be > 100MB)
          ISO_SIZE=$(stat -c%s "$ISO_PATH")
          MIN_SIZE=$((100 * 1024 * 1024))
          if [ $ISO_SIZE -lt $MIN_SIZE ]; then
            echo "Error: ISO size ($ISO_SIZE bytes) is too small"
            exit 1
          fi

          echo "âœ… ISO validation passed"
          echo "   File: $ISO_PATH"
          echo "   Size: $(numfmt --to=iec-i --suffix=B $ISO_SIZE)"

      - name: Rename ISO
        run: |
          cp "${{ steps.iso-info.outputs.iso_path }}" "${{ steps.iso-info.outputs.iso_name }}"

      - name: Upload to GitHub Actions Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: ${{ steps.iso-info.outputs.iso_name }}
          path: ${{ steps.iso-info.outputs.iso_name }}
          retention-days: 90

      - name: Upload to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.iso-info.outputs.iso_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
